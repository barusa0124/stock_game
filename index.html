<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Chart.jsライブラリのインポート -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- 時刻スケール用アダプターの追加 -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  
  <!-- Tailwind CSSをCDNから手動インライン化 -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <title>ゲーム株価ボード</title>
  <style>
    /* Tailwind CSSクラスの手動再現とカスタムスタイル */
    :root {
        font-family: 'Inter', sans-serif;
        --color-bg: #f0f4f8; 
        --color-card-bg: #fff;
        --color-border: #e5e7eb;
        --color-text-primary: #1f2937;
        --color-text-secondary: #6b7280;
        --color-indigo: rgb(79, 70, 229);
        --color-green: rgb(22, 163, 74);
        --color-red: rgb(220, 38, 38);
    }
    body {
        font-family: var(--font-family);
        background-color: var(--color-bg);
        margin: 0; padding: 0.5rem;
    }
    .max-w-6xl { max-width: 1152px; }
    .mx-auto { margin-left: auto; margin-right: auto; }

    /* カードスタイル */
    .card { 
        background-color: var(--color-card-bg);
        border: 1px solid var(--color-border);
        border-radius: 0.75rem; 
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); 
        padding: 1rem;
        margin-bottom: 1.5rem;
    }

    /* ヘッダー */
    .text-center { text-align: center; }
    .text-3xl { font-size: 1.5rem; line-height: 2rem; }
    .font-extrabold { font-weight: 800; }
    .text-indigo-700 { color: rgb(67, 56, 202); }
    .text-sm { font-size: 0.875rem; }
    .text-gray-500 { color: var(--color-text-secondary); }
    .mb-6 { margin-bottom: 1.5rem; }

    /* --- チャートエリアのレスポンシブレイアウト --- */
    .chart-wrapper {
        display: flex;
        flex-direction: column; /* デフォルト（スマホ）は縦並び */
        gap: 1rem;
    }
    
    /* PCなどの大画面用レイアウト */
    @media (min-width: 768px) {
        .chart-wrapper {
            flex-direction: row; /* 横並び */
            height: 500px; /* PCでは高さを固定してスクロールさせる */
        }
        .chart-canvas-container {
            flex: 1; /* 残りの幅を埋める */
            height: 100%;
            min-width: 0; /* Flexbox内でのCanvas縮小対策 */
        }
        .chart-legend-container {
            width: 320px; /* 凡例の幅を固定 */
            min-width: 320px;
            border-left: 1px solid var(--color-border);
            padding-left: 1rem;
            overflow-y: auto; /* 縦スクロール有効化 */
            height: 100%;
        }
        .text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
    }

    /* スマホ用調整 */
    @media (max-width: 767px) {
        .chart-canvas-container {
            height: 300px; /* スマホでのグラフの高さ */
            width: 100%;
        }
        .chart-legend-container {
            width: 100%;
            border-top: 1px solid var(--color-border);
            padding-top: 1rem;
            max-height: 400px;
            overflow-y: auto;
        }
    }

    /* 凡例アイテムのデザイン */
    .legend-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    .legend-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem;
        border-radius: 0.5rem;
        background-color: #f9fafb;
        border: 1px solid transparent;
        cursor: pointer;
        transition: all 0.2s;
    }
    .legend-item:hover {
        background-color: #f3f4f6;
        border-color: #d1d5db;
    }
    .legend-item.inactive {
        opacity: 0.6;
        background-color: #fff;
    }
    
    .legend-left {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex: 1;
        min-width: 0; /* テキスト省略のため */
    }
    .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        flex-shrink: 0;
    }
    .legend-name {
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--color-text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .legend-right {
        text-align: right;
        flex-shrink: 0;
    }
    .legend-price {
        font-weight: 700;
        font-size: 1rem;
        color: var(--color-text-primary);
    }
    .legend-change {
        font-size: 0.75rem;
        font-weight: 600;
    }

    /* チェックボックス（非表示にしてラベル全体をクリック可能にする） */
    .hidden-checkbox {
        display: none;
    }

    /* 値上がり・値下がり色 */
    .text-green { color: var(--color-green); }
    .text-red { color: var(--color-red); }
    .bg-green-100 { background-color: #dcfce7; }
    .bg-red-100 { background-color: #fee2e2; }

    /* アニメーション */
    @keyframes flash-green {
        0% { background-color: #bbf7d0; }
        100% { background-color: transparent; }
    }
    @keyframes flash-red {
        0% { background-color: #fecaca; }
        100% { background-color: transparent; }
    }
    .flash-up { animation: flash-green 1s ease-out; }
    .flash-down { animation: flash-red 1s ease-out; }

    /* イベント履歴 */
    .event-history h2 {
        font-size: 1.125rem;
        font-weight: 700;
        margin-bottom: 0.75rem;
        border-bottom: 1px solid var(--color-border);
        padding-bottom: 0.5rem;
    }
    .event-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    .event-item {
        padding-left: 0.75rem;
        border-left: 4px solid var(--color-indigo);
        margin-bottom: 0.75rem;
    }
    .event-title { font-weight: 600; color: var(--color-text-primary); font-size: 0.95rem; }
    .event-time { font-size: 0.75rem; color: var(--color-text-secondary); }

  </style>
</head>
<body class="p-4">
  <div class="max-w-6xl mx-auto">
    <header class="text-center mb-6">
      <h1 class="text-3xl font-extrabold text-indigo-700 mb-2">ゲーム内株価一覧</h1>
      <p class="text-sm text-gray-500">
        最終読み込み時刻: <span id="last-updated" class="font-medium">--</span>
      </p>
    </header>
    
    <!-- チャートと凡例（株価情報）のエリア -->
    <div class="card">
        <div class="chart-wrapper">
            <!-- グラフ本体 -->
            <div class="chart-canvas-container">
                <canvas id="combined-chart"></canvas>
                <div id="loading-message" class="flex justify-center items-center h-full text-gray-500">
                    データを読み込み中...
                </div>
            </div>
            
            <!-- 凡例と株価情報リスト -->
            <div class="chart-legend-container">
                <div class="flex justify-between items-center mb-2 sticky top-0 bg-white pb-2 border-b">
                    <h3 class="text-sm font-bold text-gray-700">銘柄・株価一覧</h3>
                    <span class="text-xs text-gray-400">クリックで表示切替</span>
                </div>
                <div id="legend-list" class="legend-list">
                    <!-- ここにJSでリストが生成されます -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- イベント履歴 -->
    <div class="card event-history">
        <h2>直近のイベント履歴</h2>
        <ul id="event-list" class="event-list">
            <li class="text-gray-500 text-sm">イベントを待機中...</li>
        </ul>
    </div>
  </div>

  <script>
    (function() {
      // --- 設定 ---
      const UPDATE_INTERVAL = 5000; 
      const HISTORY_MINUTES = 10;
      const EVENT_HISTORY_COUNT = 3; 
      const LOCAL_STORAGE_KEY = 'active_stocks_v2'; 
      const JSON_FILE_URL = './stock_schedule.json';

      // --- 変数 ---
      let pricesSchedule = []; 
      let eventsSchedule = []; 
      let ACTIVE_STOCKS = new Set(); 
      let stockChart = null; 
      
      // 8銘柄の固有色
      const STOCK_COLORS = {
          "金融": "rgb(59, 130, 246)", 
          "ヘルスケア": "rgb(16, 185, 129)", 
          "情報・通信": "rgb(239, 68, 68)", 
          "インフラ・公共事業": "rgb(245, 158, 11)", 
          "不動産": "rgb(99, 102, 241)", 
          "生活必需品": "rgb(132, 204, 22)", 
          "化学・素材": "rgb(249, 115, 22)", 
          "エネルギー": "rgb(168, 85, 247)" 
      };

      // --- ユーティリティ関数 ---

      function getYAxisScale(minPrice, maxPrice) {
          if (minPrice >= maxPrice) { 
              const center = minPrice || 1000; 
              const interval = Math.max(100, Math.floor(center * 0.05));
              return { scaleMin: center - interval, scaleMax: center + interval };
          }
          
          const range = maxPrice - minPrice;
          const roughInterval = range / 4;
          const magnitude = Math.pow(10, Math.floor(Math.log10(roughInterval)));
          let interval;
          
          const normalized = roughInterval / magnitude;
          if (normalized <= 1.5) interval = 1 * magnitude;
          else if (normalized <= 3.5) interval = 2 * magnitude;
          else if (normalized <= 7.5) interval = 5 * magnitude;
          else interval = 10 * magnitude;
          
          const scaleMin = Math.floor(minPrice / interval) * interval;
          const scaleMax = Math.ceil(maxPrice / interval) * interval;
          
          return { scaleMin, scaleMax };
      }

      // --- Chart.js 関連 ---

      function initializeChart(chartData, scaleMin, scaleMax, chartRangeMs) {
          const ctx = document.getElementById('combined-chart').getContext('2d');
          
          if (stockChart) {
              stockChart.data.datasets = chartData.datasets;
              stockChart.options.scales.y.min = scaleMin;
              stockChart.options.scales.y.max = scaleMax;
              stockChart.options.scales.x.min = Date.now() - chartRangeMs;
              stockChart.options.scales.x.max = Date.now();
              stockChart.update('none');
              return;
          }

          stockChart = new Chart(ctx, {
              type: 'line',
              data: chartData,
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  animation: { duration: 0 },
                  plugins: {
                      legend: { display: false }, // カスタム凡例を使用するため非表示
                      tooltip: { 
                          mode: 'index', 
                          intersect: false,
                          bodyFont: { size: 13 }
                      }
                  },
                  layout: { padding: { left: 0, right: 10, top: 10, bottom: 0 } },
                  scales: {
                      x: {
                          type: 'time',
                          time: {
                              unit: 'minute',
                              displayFormats: { minute: 'H:mm' }
                          },
                          min: Date.now() - chartRangeMs,
                          max: Date.now(),
                          ticks: { source: 'auto', maxTicksLimit: 6 },
                          grid: { display: false }
                      },
                      y: {
                          min: scaleMin,
                          max: scaleMax,
                          position: 'right', // Y軸を右側に配置
                          ticks: {
                              callback: (value) => value.toLocaleString(),
                              maxTicksLimit: 6
                          }
                      }
                  }
              }
          });
      }

      function updateChartData(pricesSchedule) {
          const now = Date.now();
          const historyMs = HISTORY_MINUTES * 60 * 1000;
          
          // フィルタリングされた履歴データ
          const filteredHistory = pricesSchedule.filter(entry => 
              entry.time_date.getTime() >= (now - historyMs) && entry.time_date.getTime() <= now
          );

          if (filteredHistory.length === 0) return;

          // 表示対象の銘柄の価格範囲を特定
          let activePrices = filteredHistory.flatMap(entry => entry.prices
              .filter(p => ACTIVE_STOCKS.has(p.name))
              .map(p => p.price)
          );
          
          // デフォルト範囲の設定
          let minPrice = 0, maxPrice = 100;
          if (activePrices.length > 0) {
              minPrice = Math.min(...activePrices);
              maxPrice = Math.max(...activePrices);
          } else {
             // 選択なしの場合は全データの範囲をとりあえず使う（グラフは空になる）
             let allPrices = filteredHistory.flatMap(entry => entry.prices.map(p => p.price));
             if(allPrices.length > 0) {
                 minPrice = Math.min(...allPrices);
                 maxPrice = Math.max(...allPrices);
             }
          }

          const { scaleMin, scaleMax } = getYAxisScale(minPrice, maxPrice);

          // データセット構築
          const stockNames = pricesSchedule.length > 0 ? pricesSchedule[0].prices.map(p => p.name) : [];
          const datasets = stockNames.map(name => {
              const dataPoints = filteredHistory.map(entry => {
                  const priceEntry = entry.prices.find(p => p.name === name);
                  return {
                      x: entry.time_date.getTime(),
                      y: priceEntry ? priceEntry.price : null 
                  };
              });

              return {
                  label: name,
                  data: dataPoints,
                  borderColor: STOCK_COLORS[name],
                  backgroundColor: STOCK_COLORS[name],
                  borderWidth: 2,
                  pointRadius: 0, // 点を消して線のみに
                  pointHoverRadius: 4,
                  fill: false,
                  tension: 0.1,
                  hidden: !ACTIVE_STOCKS.has(name) 
              };
          });

          initializeChart({ datasets }, scaleMin, scaleMax, historyMs);
      }

      // --- 凡例・リスト表示関連 ---

      /**
       * 凡例リスト（株価・変化率含む）を初期化または更新する
       */
      function updateLegendList(currentPrices, previousPrices) {
          const listContainer = document.getElementById('legend-list');
          
          // 初回作成
          if (listContainer.children.length === 0 && currentPrices.length > 0) {
              currentPrices.forEach(item => {
                  const name = item.name;
                  const color = STOCK_COLORS[name] || '#000';
                  
                  const div = document.createElement('div');
                  div.className = `legend-item ${ACTIVE_STOCKS.has(name) ? '' : 'inactive'}`;
                  div.id = `legend-item-${name}`;
                  div.onclick = () => toggleStock(name);
                  
                  div.innerHTML = `
                      <div class="legend-left">
                          <span class="legend-color" style="background-color: ${color};"></span>
                          <span class="legend-name">${name}</span>
                      </div>
                      <div class="legend-right">
                          <div class="legend-price" id="price-${name}">--</div>
                          <div class="legend-change" id="change-${name}">--</div>
                      </div>
                  `;
                  listContainer.appendChild(div);
              });
          }

          // 値の更新
          currentPrices.forEach(item => {
              const name = item.name;
              const priceEl = document.getElementById(`price-${name}`);
              const changeEl = document.getElementById(`change-${name}`);
              const itemEl = document.getElementById(`legend-item-${name}`);
              
              if (!priceEl) return;

              // 現在価格
              const currentPriceStr = `¥${item.price.toLocaleString()}`;
              if (priceEl.textContent !== currentPriceStr) {
                  priceEl.textContent = currentPriceStr;
                  // フラッシュアニメーション
                  const prevPriceVal = previousPrices ? (previousPrices.find(p => p.name === name)?.price || item.price) : item.price;
                  if (item.price > prevPriceVal) itemEl.classList.add('flash-up');
                  else if (item.price < prevPriceVal) itemEl.classList.add('flash-down');
                  
                  setTimeout(() => itemEl.classList.remove('flash-up', 'flash-down'), 1000);
              }

              // 変化率
              let prevPrice = previousPrices ? previousPrices.find(p => p.name === name)?.price : item.price;
              if (!prevPrice) prevPrice = item.price;
              
              const diff = item.price - prevPrice;
              const ratio = prevPrice !== 0 ? (diff / prevPrice * 100).toFixed(2) : "0.00";
              const sign = diff > 0 ? "+" : "";
              
              changeEl.textContent = `${sign}${diff} (${sign}${ratio}%)`;
              
              // 色付け
              changeEl.className = "legend-change"; // reset
              if (diff > 0) changeEl.classList.add("text-green");
              else if (diff < 0) changeEl.classList.add("text-red");
              else changeEl.classList.add("text-gray-500");
          });
      }

      function toggleStock(name) {
          if (ACTIVE_STOCKS.has(name)) {
              ACTIVE_STOCKS.delete(name);
          } else {
              ACTIVE_STOCKS.add(name);
          }
          saveActiveStocks(ACTIVE_STOCKS);
          
          // UI更新
          const itemEl = document.getElementById(`legend-item-${name}`);
          if (itemEl) {
              if (ACTIVE_STOCKS.has(name)) itemEl.classList.remove('inactive');
              else itemEl.classList.add('inactive');
          }

          // チャート更新 (hiddenフラグ切替)
          if (stockChart) {
              const datasetIndex = stockChart.data.datasets.findIndex(ds => ds.label === name);
              if (datasetIndex > -1) {
                  stockChart.data.datasets[datasetIndex].hidden = !ACTIVE_STOCKS.has(name);
              }
          }
          updateChartData(pricesSchedule); // Y軸スケール再計算のため呼び出し
      }

      function updateEventHistory(events) {
          const list = document.getElementById('event-list');
          list.innerHTML = '';
          
          if (events.length === 0) {
              list.innerHTML = '<li class="text-gray-500 text-sm">イベント待機中...</li>';
              return;
          }
          
          events.slice(0, EVENT_HISTORY_COUNT).forEach(event => {
              const time = event.time_date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
              const li = document.createElement('li');
              li.className = 'event-item';
              li.innerHTML = `
                  <div class="event-title">${event.event_title}</div>
                  <div class="event-time">${time} 発生</div>
              `;
              list.appendChild(li);
          });
      }

      // --- データロードとメインループ ---

      function loadActiveStocks(allStockNames) {
          const stored = localStorage.getItem(LOCAL_STORAGE_KEY);
          if (stored) {
              try {
                  const arr = JSON.parse(stored);
                  if (Array.isArray(arr)) {
                      ACTIVE_STOCKS = new Set(arr);
                      return;
                  }
              } catch (e) { console.error(e); }
          }
          // デフォルト全選択
          allStockNames.forEach(n => ACTIVE_STOCKS.add(n));
      }

      function saveActiveStocks(set) {
          try {
              localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(Array.from(set)));
          } catch(e) {}
      }

      async function loadSchedule() {
          const loadingMsg = document.getElementById('loading-message');
          try {
              const res = await fetch(JSON_FILE_URL);
              if (!res.ok) throw new Error(res.statusText);
              const data = await res.json();

              if (!data || !data[0] || !data[0].prices_schedule) throw new Error("Invalid JSON format");

              pricesSchedule = data[0].prices_schedule;
              eventsSchedule = data[0].events_schedule;

              // 日付変換とソート
              [pricesSchedule, eventsSchedule].forEach(arr => {
                  arr.forEach(d => d.time_date = new Date(d.time_absolute_iso));
                  arr.sort((a, b) => a.time_date - b.time_date);
              });

              // 初期化処理
              if (loadingMsg) loadingMsg.remove();
              
              const allNames = pricesSchedule.length > 0 ? pricesSchedule[0].prices.map(p => p.name) : [];
              loadActiveStocks(allNames);
              
              checkAndUpdate();
              setInterval(checkAndUpdate, UPDATE_INTERVAL);

          } catch (e) {
              if (loadingMsg) {
                  loadingMsg.textContent = "データ読み込みエラー";
                  loadingMsg.classList.add("text-red-500");
              }
              console.error(e);
          }
      }

      function checkAndUpdate() {
          if (pricesSchedule.length === 0) return;
          const now = new Date();
          
          // 最新データの特定
          let latestPriceData = null;
          let previousPriceData = null;
          
          // 時間軸に沿って現在時刻以下の最新データを探す
          for (let i = 0; i < pricesSchedule.length; i++) {
              const entry = pricesSchedule[i];
              if (entry.time_date <= now) {
                  previousPriceData = latestPriceData; // 一つ前を保存
                  latestPriceData = entry.prices;
              } else {
                  break;
              }
          }

          // イベント履歴
          const recentEvents = eventsSchedule.filter(e => e.time_date <= now).reverse();

          if (latestPriceData) {
              // 画面更新
              updateLegendList(latestPriceData, previousPriceData);
              updateEventHistory(recentEvents);
              updateChartData(pricesSchedule);
              document.getElementById('last-updated').textContent = new Date().toLocaleTimeString('ja-JP');
          } else {
              // まだ開始していない場合など
              document.getElementById('loading-message').textContent = "ゲーム開始前です";
          }
      }

      // スタート
      loadSchedule();

    })();
  </script>
</body>
</html>
