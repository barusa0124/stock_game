<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Chart.jsライブラリ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- 時刻スケール用アダプター -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  
  <!-- Tailwind CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <title>株価情報</title>
  <style>
    /* --- 基本スタイル --- */
    :root {
        font-family: 'Inter', sans-serif;
        --color-bg: #f0f4f8; 
        --color-card-bg: #fff;
        --color-border: #e5e7eb;
        --color-text-primary: #1f2937;
        --color-text-secondary: #6b7280;
        --color-indigo: rgb(79, 70, 229);
        --color-green: rgb(22, 163, 74);
        --color-red: rgb(220, 38, 38);
    }
    body {
        font-family: var(--font-family);
        background-color: var(--color-bg);
        margin: 0; padding: 0.5rem 1rem;
    }
    .max-w-6xl { max-width: 1152px; }
    .mx-auto { margin-left: auto; margin-right: auto; }

    /* カード */
    .card { 
        background-color: var(--color-card-bg);
        border: 1px solid var(--color-border);
        border-radius: 0.75rem; 
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); 
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    /* ヘッダー */
    .text-center { text-align: center; }
    .text-3xl { font-size: 1.5rem; line-height: 2rem; font-weight: 800; color: var(--color-indigo); }
    .text-sm { font-size: 0.875rem; color: var(--color-text-secondary); }
    .mb-6 { margin-bottom: 1.5rem; }

    /* チャートエリア */
    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        border-bottom: 1px solid var(--color-border);
        padding-bottom: 0.5rem;
    }
    .text-xl { font-size: 1.25rem; font-weight: 700; color: var(--color-text-primary); }
    
    .chart-wrapper {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    @media (min-width: 768px) {
        .chart-wrapper {
            flex-direction: row;
            height: 500px;
        }
        .chart-canvas-container {
            flex: 1;
            height: 100%;
            min-width: 0; 
        }
        .chart-legend-container {
            width: 300px; 
            min-width: 300px;
            border-left: 1px solid var(--color-border);
            padding-left: 1rem;
            overflow-y: auto; 
            height: 100%;
        }
    }
    @media (max-width: 767px) {
        .chart-canvas-container { height: 300px; width: 100%; }
        .chart-legend-container { width: 100%; border-top: 1px solid var(--color-border); padding-top: 1rem; max-height: 400px; overflow-y: auto; }
    }

    /* 凡例リスト */
    .legend-list { display: flex; flex-direction: column; gap: 0.5rem; }
    .legend-item {
        display: flex; align-items: center; justify-content: space-between;
        padding: 0.5rem; border-radius: 0.5rem;
        background-color: #f9fafb; cursor: pointer; transition: all 0.2s;
    }
    .legend-item:hover { background-color: #f3f4f6; }
    .legend-item.inactive { opacity: 0.3; filter: grayscale(100%); background-color: #fff; }
    
    .legend-left { display: flex; align-items: center; gap: 0.5rem; flex: 1; min-width: 0; }
    .legend-color { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
    .legend-name { font-weight: 600; font-size: 0.9rem; color: var(--color-text-primary); }
    
    .legend-right { text-align: right; flex-shrink: 0; }
    .legend-price { font-weight: 700; font-size: 0.95rem; color: var(--color-text-primary); }
    .legend-change { font-size: 0.75rem; font-weight: 600; }

    /* 株価カード */
    #price-board { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; }
    .stock-card {
        background-color: #fff; border: 1px solid var(--color-border); border-radius: 0.75rem;
        padding: 1.25rem; display: flex; flex-direction: column; justify-content: center;
    }
    .stock-name { font-size: 1.25rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem; }
    .stock-values { display: flex; align-items: flex-end; justify-content: space-between; }
    .stock-price { font-size: 2.25rem; font-weight: 800; color: var(--color-indigo); }
    .stock-change-group { text-align: right; }
    .stock-diff { font-size: 1.125rem; font-weight: 700; }
    .stock-ratio { font-size: 0.875rem; }

    /* イベント履歴 */
    .event-history h2 { margin-bottom: 0.75rem; border-bottom: 1px solid var(--color-border); padding-bottom: 0.5rem; }
    .event-list { list-style: none; padding: 0; margin: 0; }
    .event-item { padding-left: 0.75rem; border-left: 4px solid var(--color-indigo); margin-bottom: 0.75rem; padding-top: 0.25rem; padding-bottom: 0.25rem; }
    .event-title { font-weight: 600; font-size: 0.95rem; }
    .event-time { font-size: 0.75rem; color: var(--color-text-secondary); }

    /* ユーティリティ */
    .text-green { color: var(--color-green); }
    .text-red { color: var(--color-red); }
    .text-gray { color: var(--color-text-secondary); }
    .hidden-checkbox { display: none; }
    
    /* プルダウンメニュー */
    select {
        background-color: #fff;
        border: 1px solid var(--color-border);
        border-radius: 0.375rem;
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        color: var(--color-text-primary);
        cursor: pointer;
    }

    /* アニメーション */
    @keyframes flash-green { 0% { background-color: #bbf7d0; } 100% { background-color: transparent; } }
    @keyframes flash-red { 0% { background-color: #fecaca; } 100% { background-color: transparent; } }
    @keyframes flash-yellow { 0% { background-color: #fef08a; } 100% { background-color: transparent; } }
    
    .flash-up { animation: flash-green 1s ease-out; }
    .flash-down { animation: flash-red 1s ease-out; }
    .flash-highlight { animation: flash-yellow 2s ease-out; }
  </style>
</head>
<body class="p-4">
  <div class="max-w-6xl mx-auto">
    <header class="text-center mb-6">
      <h1 class="text-3xl">株価情報</h1>
      <p class="text-sm">最終読み込み時刻: <span id="last-updated">--</span></p>
    </header>
    
    <!-- チャートエリア -->
    <div class="card">
        <div class="chart-header">
            <div class="flex items-center gap-4" style="display:flex; align-items:center; gap:1rem;">
                <h2 class="text-xl">株価推移</h2>
                <select id="time-range-selector">
                    <!-- JSで生成 -->
                </select>
            </div>
        </div>
        <div class="chart-wrapper">
            <div class="chart-canvas-container">
                <canvas id="combined-chart"></canvas>
                <div id="loading-message" style="display:flex; justify-content:center; align-items:center; height:100%; color:#6b7280;">
                    データを読み込み中...
                </div>
            </div>
            <div class="chart-legend-container">
                <div style="display:flex; justify-content:space-between; margin-bottom:0.5rem; border-bottom:1px solid #e5e7eb; padding-bottom:0.5rem;">
                    <h3 style="font-size:0.875rem; font-weight:bold; color:#374151;">銘柄・株価一覧</h3>
                    <span style="font-size:0.75rem; color:#9ca3af;">クリックで表示切替</span>
                </div>
                <div id="legend-list" class="legend-list"></div>
            </div>
        </div>
    </div>
    
    <!-- イベント履歴 -->
    <div class="card event-history">
        <h2>直近のイベント履歴</h2>
        <ul id="event-list" class="event-list">
            <li style="color:#6b7280; font-size:0.875rem;">イベント待機中...</li>
        </ul>
    </div>

    <!-- 株価カードエリア -->
    <div class="lg:col-span-2">
       <h2 class="text-xl" style="margin-bottom:1rem; border-bottom:1px solid #e5e7eb; padding-bottom:0.5rem;">全銘柄の現在の株価と変動</h2>
       <div id="price-board"></div>
    </div>
  </div>

  <script>
    (function() {
      // --- 設定 ---
      const UPDATE_INTERVAL = 5000; 
      const EVENT_HISTORY_COUNT = 3; 
      const LOCAL_STORAGE_KEY = 'active_stocks_v2'; 
      const JSON_FILE_URL = './stock_schedule.json'; // 本番用JSONファイル

      const TIME_RANGE_OPTIONS = [
          { label: '直近 5分', value: 5 },
          { label: '直近 10分', value: 10 },
          { label: '直近 30分', value: 30 },
          { label: '直近 1時間', value: 60 },
      ];
      let currentHistoryMinutes = 10; 

      let pricesSchedule = []; 
      let eventsSchedule = []; 
      let ACTIVE_STOCKS = new Set(); 
      let stockChart = null; 
      let dynamicStockColors = {}; 

      const COLOR_PALETTE = [
          "rgb(59, 130, 246)", "rgb(16, 185, 129)", "rgb(239, 68, 68)", 
          "rgb(245, 158, 11)", "rgb(99, 102, 241)", "rgb(132, 204, 22)", 
          "rgb(249, 115, 22)", "rgb(168, 85, 247)", "rgb(236, 72, 153)", "rgb(6, 182, 212)"
      ];

      // --- ユーティリティ ---
      function getColorForStock(name) {
          if (dynamicStockColors[name]) return dynamicStockColors[name];
          const index = Object.keys(dynamicStockColors).length;
          const color = COLOR_PALETTE[index % COLOR_PALETTE.length];
          dynamicStockColors[name] = color;
          return color;
      }

      function getYAxisScale(minPrice, maxPrice) {
          if (minPrice >= maxPrice) { 
              const center = minPrice || 1000; 
              const interval = Math.max(100, Math.floor(center * 0.05));
              return { scaleMin: center - interval, scaleMax: center + interval };
          }
          const range = maxPrice - minPrice;
          const roughInterval = range / 4;
          const magnitude = Math.pow(10, Math.floor(Math.log10(roughInterval)));
          let interval;
          const normalized = roughInterval / magnitude;
          if (normalized <= 1.5) interval = 1 * magnitude;
          else if (normalized <= 3.5) interval = 2 * magnitude;
          else if (normalized <= 7.5) interval = 5 * magnitude;
          else interval = 10 * magnitude;
          return { scaleMin: Math.floor(minPrice / interval) * interval, scaleMax: Math.ceil(maxPrice / interval) * interval };
      }

      // --- 各更新関数 ---

      // 1. 凡例リスト更新
      function updateLegendList(currentPrices, previousPrices) {
          const listContainer = document.getElementById('legend-list');
          if (listContainer.children.length !== currentPrices.length) {
              listContainer.innerHTML = '';
              currentPrices.forEach(item => {
                  const name = item.name;
                  const color = getColorForStock(name);
                  const div = document.createElement('div');
                  div.className = `legend-item ${ACTIVE_STOCKS.has(name) ? '' : 'inactive'}`;
                  div.id = `legend-item-${name}`;
                  div.onclick = () => toggleStock(name);
                  div.innerHTML = `
                      <div class="legend-left">
                          <span class="legend-color" style="background-color: ${color};"></span>
                          <span class="legend-name">${name}</span>
                      </div>
                      <div class="legend-right">
                          <div class="legend-price" id="legend-price-${name}">--</div>
                          <div class="legend-change" id="legend-change-${name}">--</div>
                      </div>
                  `;
                  listContainer.appendChild(div);
              });
          }

          currentPrices.forEach(item => {
              const name = item.name;
              const priceEl = document.getElementById(`legend-price-${name}`);
              const changeEl = document.getElementById(`legend-change-${name}`);
              const itemEl = document.getElementById(`legend-item-${name}`);
              
              if (!priceEl) return;

              const currentPriceStr = `¥${item.price.toLocaleString()}`;
              if (priceEl.textContent !== currentPriceStr) {
                  priceEl.textContent = currentPriceStr;
                  const prevPriceVal = previousPrices ? (previousPrices.find(p => p.name === name)?.price || item.price) : item.price;
                  if (item.price > prevPriceVal) itemEl.classList.add('flash-up');
                  else if (item.price < prevPriceVal) itemEl.classList.add('flash-down');
                  setTimeout(() => itemEl.classList.remove('flash-up', 'flash-down'), 1000);
              }

              let prevPrice = previousPrices ? previousPrices.find(p => p.name === name)?.price : item.price;
              if (!prevPrice) prevPrice = item.price;
              const diff = item.price - prevPrice;
              const ratio = prevPrice !== 0 ? (diff / prevPrice * 100).toFixed(2) : "0.00";
              const sign = diff > 0 ? "+" : "";
              changeEl.textContent = `${sign}${diff} (${sign}${ratio}%)`;
              changeEl.className = "legend-change"; 
              if (diff > 0) changeEl.classList.add("text-green");
              else if (diff < 0) changeEl.classList.add("text-red");
              else changeEl.classList.add("text-gray");
          });
      }

      // 2. 下部のカード更新
      function updatePriceCards(currentPrices, previousPrices) {
        const board = document.getElementById('price-board');
        if (!board.children.length) board.innerHTML = '';

        currentPrices.forEach(item => {
          const safeName = item.name.replace(/[^a-zA-Z0-9\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/g, ''); 
          const cardId = `card-${safeName}`;
          
          let existingElement = document.getElementById(cardId);
          let prevPrice = previousPrices ? previousPrices.find(p => p.name === item.name)?.price : item.price;
          if(!prevPrice) prevPrice = item.price;
          
          const changeAmount = item.price - prevPrice;
          const changeRatio = prevPrice > 0 ? (changeAmount / prevPrice) * 100 : 0;
          const sign = changeAmount >= 0 ? '▲' : '▼';
          const colorClass = changeAmount >= 0 ? 'text-green' : 'text-red';

          if (!existingElement) {
              const newDiv = document.createElement('div');
              newDiv.id = cardId;
              newDiv.className = "stock-card";
              newDiv.innerHTML = `
                  <div class="stock-name">${item.name}</div>
                  <div class="stock-values">
                    <span class="stock-price">¥ ${item.price.toLocaleString()}</span>
                    <div class="stock-change-group">
                        <div class="stock-diff ${colorClass}">${sign} ${changeAmount.toLocaleString()}</div>
                        <div class="stock-ratio ${colorClass}">(${changeRatio.toFixed(2)}%)</div>
                    </div>
                  </div>
              `;
              board.appendChild(newDiv);
          } else {
              const priceSpan = existingElement.querySelector('.stock-price');
              const diffDiv = existingElement.querySelector('.stock-diff');
              const ratioDiv = existingElement.querySelector('.stock-ratio');
              
              if (priceSpan.textContent !== `¥ ${item.price.toLocaleString()}`) {
                  priceSpan.textContent = `¥ ${item.price.toLocaleString()}`;
                  existingElement.classList.add(changeAmount >= 0 ? 'flash-up' : 'flash-down');
                  setTimeout(() => existingElement.classList.remove('flash-up', 'flash-down'), 1000);
              }
              
              diffDiv.className = `stock-diff ${colorClass}`;
              diffDiv.textContent = `${sign} ${changeAmount.toLocaleString()}`;
              ratioDiv.className = `stock-ratio ${colorClass}`;
              ratioDiv.textContent = `(${changeRatio.toFixed(2)}%)`;
          }
        });
      }

      // 3. イベント履歴更新
      function updateEventHistory(events) {
          const list = document.getElementById('event-list');
          
          if (events.length === 0) {
              if (!list.innerHTML.includes('イベント待機中')) {
                 list.innerHTML = '<li style="color:#6b7280; font-size:0.875rem;">イベント待機中...</li>';
              }
              return;
          }
          
          // 待機中メッセージ削除
          if (list.querySelector('li[style*="color:#6b7280"]')) list.innerHTML = '';

          const displayEvents = events.slice(0, EVENT_HISTORY_COUNT);
          const existingIds = new Set();
          Array.from(list.children).forEach(li => {
              if (li.dataset.eventId) existingIds.add(li.dataset.eventId);
          });

          const currentIds = new Set(displayEvents.map(e => e.time_absolute_iso));
          Array.from(list.children).forEach(li => {
             if(li.dataset.eventId && !currentIds.has(li.dataset.eventId)) {
                 li.remove();
             }
          });

          displayEvents.slice().reverse().forEach(event => {
              const eventId = event.time_absolute_iso;
              if (!existingIds.has(eventId)) {
                   const time = event.time_date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                   const li = document.createElement('li');
                   li.className = 'event-item flash-highlight'; 
                   li.dataset.eventId = eventId;
                   li.innerHTML = `<div class="event-title">${event.event_title}</div><div class="event-time">${time} 発生</div>`;
                   list.prepend(li);
                   setTimeout(() => li.classList.remove('flash-highlight'), 2000);
              }
          });
      }

      // 4. チャート更新
      function initializeChart(chartData, scaleMin, scaleMax, chartRangeMs) {
          const ctx = document.getElementById('combined-chart').getContext('2d');
          if (stockChart) {
              stockChart.data.datasets = chartData.datasets;
              stockChart.options.scales.y.min = scaleMin;
              stockChart.options.scales.y.max = scaleMax;
              stockChart.options.scales.x.min = Date.now() - chartRangeMs;
              stockChart.options.scales.x.max = Date.now();
              stockChart.update('none');
              return;
          }
          stockChart = new Chart(ctx, {
              type: 'line',
              data: chartData,
              options: {
                  responsive: true, maintainAspectRatio: false, animation: { duration: 0 },
                  plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
                  layout: { padding: { left: 0, right: 10, top: 10, bottom: 0 } },
                  scales: {
                      x: { type: 'time', time: { unit: 'minute', displayFormats: { minute: 'H:mm' } }, min: Date.now() - chartRangeMs, max: Date.now(), ticks: { source: 'auto', maxTicksLimit: 6 }, grid: { display: false } },
                      y: { min: scaleMin, max: scaleMax, position: 'right', ticks: { callback: (v) => v.toLocaleString(), maxTicksLimit: 6 } }
                  }
              }
          });
      }

      function updateChartData(pricesSchedule) {
          const now = Date.now();
          const historyMs = currentHistoryMinutes * 60 * 1000;
          const filteredHistory = pricesSchedule.filter(entry => entry.time_date.getTime() >= (now - historyMs) && entry.time_date.getTime() <= now);

          if (filteredHistory.length === 0) {
              const msg = document.getElementById('loading-message');
              if (msg) { msg.style.display = 'flex'; msg.textContent = '履歴データなし'; }
              if (stockChart) { stockChart.destroy(); stockChart = null; }
              return;
          } else {
              const msg = document.getElementById('loading-message');
              if (msg) msg.style.display = 'none';
          }

          let activePrices = filteredHistory.flatMap(entry => entry.prices.filter(p => ACTIVE_STOCKS.has(p.name)).map(p => p.price));
          let minPrice = 0, maxPrice = 100;
          if (activePrices.length > 0) {
              minPrice = Math.min(...activePrices); maxPrice = Math.max(...activePrices);
          } else {
             let allPrices = filteredHistory.flatMap(entry => entry.prices.map(p => p.price));
             if(allPrices.length > 0) { minPrice = Math.min(...allPrices); maxPrice = Math.max(...allPrices); }
          }
          const { scaleMin, scaleMax } = getYAxisScale(minPrice, maxPrice);

          const stockNames = pricesSchedule.length > 0 ? pricesSchedule[0].prices.map(p => p.name) : [];
          const datasets = stockNames.map(name => {
              const dataPoints = filteredHistory.map(entry => {
                  const priceEntry = entry.prices.find(p => p.name === name);
                  return { x: entry.time_date.getTime(), y: priceEntry ? priceEntry.price : null };
              });
              const color = getColorForStock(name);
              return {
                  label: name, data: dataPoints, borderColor: color, backgroundColor: color,
                  borderWidth: 2, pointRadius: 0, pointHoverRadius: 4, fill: false, tension: 0.1,
                  hidden: !ACTIVE_STOCKS.has(name)
              };
          });
          initializeChart({ datasets }, scaleMin, scaleMax, historyMs);
      }

      function toggleStock(name) {
          if (ACTIVE_STOCKS.has(name)) ACTIVE_STOCKS.delete(name); else ACTIVE_STOCKS.add(name);
          saveActiveStocks(ACTIVE_STOCKS);
          const itemEl = document.getElementById(`legend-item-${name}`);
          if (itemEl) {
              if (ACTIVE_STOCKS.has(name)) itemEl.classList.remove('inactive'); else itemEl.classList.add('inactive');
              const input = itemEl.querySelector('input');
              if(input) input.checked = ACTIVE_STOCKS.has(name);
          }
          if (stockChart) {
              const idx = stockChart.data.datasets.findIndex(ds => ds.label === name);
              if (idx > -1) stockChart.data.datasets[idx].hidden = !ACTIVE_STOCKS.has(name);
          }
          updateChartData(pricesSchedule);
      }

      // --- メイン制御 ---

      function checkAndUpdate() {
          if (pricesSchedule.length === 0) return;
          const now = new Date();
          
          let latestPriceData = null;
          let previousPriceData = null;
          for (let i = 0; i < pricesSchedule.length; i++) {
              const entry = pricesSchedule[i];
              if (entry.time_date <= now) {
                  previousPriceData = latestPriceData; 
                  latestPriceData = entry.prices;
              } else { break; }
          }

          const recentEvents = eventsSchedule.filter(e => e.time_date <= now).reverse();

          if (latestPriceData) {
              updateLegendList(latestPriceData, previousPriceData);
              updatePriceCards(latestPriceData, previousPriceData);
              updateEventHistory(recentEvents);
              updateChartData(pricesSchedule);
              document.getElementById('last-updated').textContent = new Date().toLocaleTimeString('ja-JP');
          } else {
              const msg = document.getElementById('loading-message');
              if(msg) { msg.style.display = 'flex'; msg.textContent = "ゲーム開始前です"; }
          }
      }

      function loadSchedule() {
          // 外部JSONファイルを読み込む (本番環境用)
          const loadingMsg = document.getElementById('loading-message');
          if(loadingMsg) loadingMsg.style.display = 'flex';

          fetch(JSON_FILE_URL)
            .then(res => {
                if (!res.ok) throw new Error(res.statusText);
                return res.json();
            })
            .then(data => {
                if (!data || !data[0] || !data[0].prices_schedule) throw new Error("Invalid JSON format");

                pricesSchedule = data[0].prices_schedule;
                eventsSchedule = data[0].events_schedule;

                [pricesSchedule, eventsSchedule].forEach(arr => {
                    arr.forEach(d => d.time_date = new Date(d.time_absolute_iso));
                    arr.sort((a, b) => a.time_date - b.time_date);
                });

                if (loadingMsg) loadingMsg.style.display = 'none';

                const allNames = pricesSchedule.length > 0 ? pricesSchedule[0].prices.map(p => p.name) : [];
                loadActiveStocks(allNames);
                initTimeRangeSelector();
                
                // 凡例の初期化（データが読み込まれてから）
                const legendContainer = document.getElementById('legend-list');
                legendContainer.innerHTML = '';

                checkAndUpdate();
                setInterval(checkAndUpdate, UPDATE_INTERVAL);
            })
            .catch(e => {
                 if (loadingMsg) {
                    loadingMsg.textContent = "データ読み込みエラー";
                    loadingMsg.classList.add("text-red");
                 }
                 console.error(e);
            });
      }

      function initTimeRangeSelector() {
          const select = document.getElementById('time-range-selector');
          select.innerHTML = '';
          const opts = [ { label: '直近 5分', value: 5 }, { label: '直近 10分', value: 10 }, { label: '直近 30分', value: 30 }, { label: '直近 1時間', value: 60 } ];
          opts.forEach(opt => {
              const o = document.createElement('option');
              o.value = opt.value; o.textContent = opt.label;
              if (opt.value === currentHistoryMinutes) o.selected = true;
              select.appendChild(o);
          });
          select.addEventListener('change', (e) => {
              currentHistoryMinutes = parseInt(e.target.value, 10);
              updateChartData(pricesSchedule);
          });
      }

      function loadActiveStocks(allStockNames) {
          const stored = localStorage.getItem(LOCAL_STORAGE_KEY);
          if (stored) {
              try {
                  const arr = JSON.parse(stored);
                  if (Array.isArray(arr)) { ACTIVE_STOCKS = new Set(arr); return; }
              } catch (e) {}
          }
          allStockNames.forEach(n => ACTIVE_STOCKS.add(n));
      }
      function saveActiveStocks(set) {
          try { localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(Array.from(set))); } catch(e) {}
      }

      // 実行
      loadSchedule();

    })();
  </script>
</body>
</html>
